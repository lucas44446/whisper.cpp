name: Build whisper.wasm demo
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        # Uwaga: najnowszy master NIE ma już targetu 'whisper.wasm'.
        # Jeśli chcesz koniecznie stary przykład 'examples/whisper.wasm',
        # ustaw tu konkretne SHA z historii, w którym on istniał:
        # with:
        #   ref: <WSTAW_SHA_Z_HISTORII>

      - name: Set up Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: latest

      # Konfiguracja z katalogu głównego
      - name: Configure (emcmake)
        run: |
          emcmake cmake -S . -B build-wasm \
            -DGGML_WASM=ON \
            -DGGML_WASM_SIMD=ON

      # ⚠️ Jeżeli budujesz NAJNOWSZY master, nie ma targetu 'whisper.wasm'
      # (dlatego poprzedni run krzyczał: "No rule to make target 'whisper.wasm'")
      # Wtedy ten krok można tymczasowo pominąć lub zbudować inne web-targety GGML.
      # Jeśli podepniesz stare SHA z przykładem whisper.wasm, to odkomentuj:
      # - name: Build whisper.wasm
      #   run: cmake --build build-wasm -j 4 --target whisper.wasm

      # Zbieranie plików demo (zależnie od wersji repo mogą być w różnych miejscach)
        - name: Collect demo files
    run: |
      mkdir -p dist

      # main.js z wbudowanym WASM (najnowszy ggml/whisper.cpp)
      if [ -f build-wasm/bin/main.js ]; then
        cp -v build-wasm/bin/main.js dist/
      fi

      # (opcjonalnie – stream/command/bench)
      for f in stream.js command.js bench.js; do
        [ -f "build-wasm/bin/$f" ] && cp -v "build-wasm/bin/$f" dist/
      done

      # index.html
      if [ -f build-wasm/examples/whisper.wasm/index.html ]; then
        cp -v build-wasm/examples/whisper.wasm/index.html dist/index.html
      else
        cp -v examples/whisper.wasm/index-tmpl.html dist/index.html
      fi

      ls -la dist


      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-wasm-demo
          path: dist/*
